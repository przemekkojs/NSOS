FROM node:22-alpine AS build-stage

ARG NUXT_PUBLIC_API_URL
ARG NUXT_PUBLIC_APP_URL
ARG NUXT_PUBLIC_RAG_URL

ARG NUXT_PUBLIC_FEATURE_FLAG_AI_CHAT
ARG NUXT_PUBLIC_FEATURE_INSTITUTIONS
ARG NUXT_PUBLIC_FEATURE_FLAG_CSV_IMPORT
ARG NUXT_PUBLIC_FEATURE_FLAG_USER_AVATARS

# Fail if not provided
RUN test -n "$NUXT_PUBLIC_API_URL" || (echo "ERROR: NUXT_PUBLIC_API_URL build arg is required" && exit 1)
RUN test -n "$NUXT_PUBLIC_APP_URL" || (echo "ERROR: NUXT_PUBLIC_APP_URL build arg is required" && exit 1)


ENV NUXT_PUBLIC_API_URL=$NUXT_PUBLIC_API_URL
ENV NUXT_PUBLIC_APP_URL=$NUXT_PUBLIC_APP_URL
ENV NUXT_PUBLIC_RAG_URL=$NUXT_PUBLIC_RAG_URL

ARG NUXT_PUBLIC_FEATURE_FLAG_AI_CHAT=${NUXT_PUBLIC_FEATURE_FLAG_AI_CHAT}
ARG NUXT_PUBLIC_FEATURE_INSTITUTIONS=${NUXT_PUBLIC_FEATURE_INSTITUTIONS}
ARG NUXT_PUBLIC_FEATURE_FLAG_CSV_IMPORT=${NUXT_PUBLIC_FEATURE_FLAG_CSV_IMPORT}
ARG NUXT_PUBLIC_FEATURE_FLAG_USER_AVATARS=${NUXT_PUBLIC_FEATURE_FLAG_USER_AVATARS}

WORKDIR /app

COPY package*.json package-lock.json ./
RUN npm ci --ignore-scripts || npm install --ignore-scripts

COPY . .
RUN npm run generate

# Production stage
FROM nginx:stable-alpine AS production-stage

COPY nginx.conf /etc/nginx/nginx.conf

COPY --from=build-stage /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
